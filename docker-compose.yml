services:
  # Web UI - Production Build
  # Serves static files built with Vite
  webui:
    build:
      context: ./web/app
      dockerfile: Dockerfile
    ports:
      - '8010:8010'
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8010/']
      interval: 30s
      timeout: 5s
      retries: 3

  # Engineering-Analytics Bounded Context - Microservices
  # MetricsCollector: Ingests raw engineering data from sources (version control, CI/CD)
  metrics-collector:
    build:
      context: ./services/engineering-analytics/microservices/metrics-collector
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-metrics-collector:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-metrics-collector:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8031/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # KPIEngine: Calculates DORA metrics, code quality scores, and reliability indicators
  kpi-engine:
    build:
      context: ./services/engineering-analytics/microservices/kpi-engine
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-kpi-engine:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-kpi-engine:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8032/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # InsightsDashboard: Serves visualization endpoints and pre-built reports
  insights-dashboard:
    build:
      context: ./services/engineering-analytics/microservices/insights-dashboard
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-insights-dashboard:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-insights-dashboard:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8033/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # Goal-Management Bounded Context - Microservices
  # ObjectiveService: Manages lifecycle of objectives (create/update/archive)
  objective-service:
    build:
      context: ./services/goal-management/microservices/objective-service
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-objective-service:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-objective-service:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8041/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # KeyResultTracker: Tracks progress against measurable results
  key-result-tracker:
    build:
      context: ./services/goal-management/microservices/key-result-tracker
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-key-result-tracker:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-key-result-tracker:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8042/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # HR-Management Bounded Context - Microservices
  # EmployeeRegistry: Central source for employee profiles and skills
  employee-registry:
    build:
      context: ./services/hr-management/microservices/employee-registry
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-employee-registry:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-employee-registry:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8021/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # AllocationEngine: Optimizes workforce allocation across projects
  allocation-engine:
    build:
      context: ./services/hr-management/microservices/allocation-engine
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-allocation-engine:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-allocation-engine:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8022/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # Project-Management Bounded Context - Microservices
  # SprintCoordinator: Manages sprint planning/execution
  sprint-coordinator:
    build:
      context: ./services/project-management/microservices/sprint-coordinator
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-sprint-coordinator:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-sprint-coordinator:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8051/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # TaskDispatcher: Assigns tasks to team members based on skills/availability
  task-dispatcher:
    build:
      context: ./services/project-management/microservices/task-dispatcher
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-task-dispatcher:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-task-dispatcher:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8052/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # System-Integration Bounded Context - Microservices
  # DataPipeline: ETL processing for Jira/GitLab/Firebase
  data-pipeline:
    build:
      context: ./services/system-integration/microservices/data-pipeline
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-data-pipeline:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-data-pipeline:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8061/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # API Gateway Service: Unified entry point with routing/security (Go/Gin)
  # Replaces nginx-proxy - now handles all routing including frontend, Ollama, and Docker Registry
  api-gateway-service:
    build:
      context: ./services/system-integration/microservices/api-gateway
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-api-gateway-service:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-api-gateway-service:cache,mode=max
    ports:
      - '8080:8060'
    extra_hosts:
      - 'host.docker.internal:host-gateway'
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8060/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # Workforce-Wellbeing Bounded Context - Microservices
  # WellbeingMonitor: Collects wellbeing indicators (surveys, activity logs)
  wellbeing-monitor:
    build:
      context: ./services/workforce-wellbeing/microservices/wellbeing-monitor
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-wellbeing-monitor:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-wellbeing-monitor:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8071/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # BurnoutPredictor: Identifies burnout risks using ML models
  burnout-predictor:
    build:
      context: ./services/workforce-wellbeing/microservices/burnout-predictor
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-burnout-predictor:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-burnout-predictor:cache,mode=max
    networks:
      - app-network
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8072/health']
      interval: 30s
      timeout: 5s
      retries: 3

  # Unified-Analytics Bounded Context - Microservices
  # UnifiedAnalyticsAPI: Dashboard config, incident attribution, performance reviews, platform sync
  unified-analytics-api:
    build:
      context: ./services/unified-analytics/microservices/unified-analytics-api
      dockerfile: Dockerfile
      cache_from:
        - type=registry,ref=host.docker.internal:5006/ugjb-unified-analytics-api:cache
      cache_to:
        - type=registry,ref=host.docker.internal:5006/ugjb-unified-analytics-api:cache,mode=max
    environment:
      - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/unified_analytics
      - EMPLOYEE_REGISTRY_URL=http://employee-registry:8021
      - METRICS_COLLECTOR_URL=http://metrics-collector:8031
      - LATTICE_API_URL=${LATTICE_API_URL:-}
      - LATTICE_API_KEY=${LATTICE_API_KEY:-}
      - MONDAY_API_URL=${MONDAY_API_URL:-https://api.monday.com/v2}
      - MONDAY_API_KEY=${MONDAY_API_KEY:-}
      - DEVLAKE_API_URL=${DEVLAKE_API_URL:-}
    networks:
      - app-network
    depends_on:
      - employee-registry
      - metrics-collector
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/health']
      interval: 30s
      timeout: 5s
      retries: 3


  # Bugsink - Self-hosted Error Tracking
  # Captures application errors with stacktraces, alerting, and issue grouping
  sentry:
    image: bugsink/bugsink:latest
    environment:
      - SECRET_KEY=${BUGSINK_SECRET_KEY:-change-me-in-production}
      - CREATE_SUPERUSER=${BUGSINK_ADMIN:-admin:admin}
      - PORT=8000
      - BEHIND_HTTPS_PROXY=${BEHIND_HTTPS_PROXY:-False}
    volumes:
      - bugsink-data:/app/data
    networks:
      - app-network
    restart: unless-stopped
    healthcheck:
      test: ['CMD', 'curl', '-f', 'http://localhost:8000/']
      interval: 30s
      timeout: 5s
      retries: 3

networks:
  app-network:
    driver: bridge

volumes:
  bugsink-data:
